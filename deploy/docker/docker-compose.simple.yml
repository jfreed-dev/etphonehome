# ET Phone Home Server - Simplified Docker Compose
# Single container deployment with persistent volumes
#
# Configuration: /home/etphonehome/appdata/phonehome/config/server.env
# Data: /home/etphonehome/appdata/phonehome/data/

services:
  etphonehome:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.simple
    image: etphonehome-server:latest
    container_name: etphonehome-server
    restart: unless-stopped

    # Use host network so container can reach SSH reverse tunnels on localhost
    network_mode: host

    # Run as the host etphonehome user for proper file permissions
    user: "1001:1001"

    # Load environment from consolidated config file
    env_file:
      - /home/etphonehome/appdata/phonehome/config/server.env

    volumes:
      # Persistent client data - consolidated appdata location
      - /home/etphonehome/appdata/phonehome/data:/data
      # Optional: logs directory
      - /var/log/etphonehome:/var/log/etphonehome

    environment:
      # Set HOME to writable directory for command history DB
      - HOME=/data

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

    # Resource limits (optional, uncomment to enable)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 512M
    #     reservations:
    #       memory: 128M

# Example .env file:
# ETPHONEHOME_API_KEY=your-secure-api-key
# LOG_LEVEL=INFO
# WEBHOOK_URL=http://your-webhook-endpoint/webhook
