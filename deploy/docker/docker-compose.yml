# Reach - Docker Compose Configuration
#
# Usage:
#   docker-compose up -d              # Start server
#   docker-compose --profile client up # Start with client
#   docker-compose logs -f            # View logs
#
# For production, set environment variables or use .env file

services:
  server:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.server
    image: reach-server:latest
    container_name: reach-server
    restart: unless-stopped
    ports:
      - "${REACH_PORT:-8765}:8765"
      - "${SSH_PORT:-2222}:22"
    environment:
      - REACH_LOG_LEVEL=${REACH_LOG_LEVEL:-INFO}
      - REACH_API_KEY=${REACH_API_KEY:-}
      - REACH_LOG_FILE=/var/log/reach/server.log
      - REACH_LOG_MAX_BYTES=${REACH_LOG_MAX_BYTES:-10485760}
      - REACH_LOG_BACKUP_COUNT=${REACH_LOG_BACKUP_COUNT:-5}
    volumes:
      - server-data:/var/lib/reach
      - server-logs:/var/log/reach
      - ${SSH_HOST_KEYS:-./ssh_host_keys}:/etc/ssh/keys:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - reach

  # SSH server for client connections (optional, run with --profile ssh)
  ssh:
    image: linuxserver/openssh-server:latest
    container_name: reach-ssh
    profiles:
      - ssh
    restart: unless-stopped
    ports:
      - "${SSH_PORT:-2222}:2222"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-UTC}
      - USER_NAME=reach
      - PUBLIC_KEY_FILE=/config/authorized_keys
      - SUDO_ACCESS=false
      - PASSWORD_ACCESS=false
    volumes:
      - ssh-config:/config
      - ${AUTHORIZED_KEYS_FILE:-./authorized_keys}:/config/authorized_keys:ro
    networks:
      - reach

  # Client container (optional, run with --profile client)
  client:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.client
    image: reach-client:latest
    container_name: reach-client
    profiles:
      - client
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - client-config:/home/reach/.reach
      - ${CLIENT_SSH_KEY:-./client_key}:/home/reach/.reach/id_ed25519:ro
    depends_on:
      - server
    networks:
      - reach

volumes:
  server-data:
  server-logs:
  ssh-config:
  client-config:

networks:
  reach:
    driver: bridge
