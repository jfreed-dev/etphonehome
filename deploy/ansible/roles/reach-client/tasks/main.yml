# Reach Client Role
---
- name: Set client user
  ansible.builtin.set_fact:
    _reach_user: "{{ reach_user | default(ansible_user) }}"

- name: Get user home directory
  ansible.builtin.shell: "echo ~{{ _reach_user }}"
  register: user_home
  changed_when: false

- name: Set home directory fact
  ansible.builtin.set_fact:
    _reach_home: "{{ user_home.stdout }}"

- name: Install system dependencies
  become: true
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: Create config directory
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.file:
    path: "{{ _reach_home }}/.reach/logs"
    state: directory
    mode: "0700"

- name: Create Python virtual environment
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.command:
    cmd: python3 -m venv {{ _reach_home }}/.reach/venv
    creates: "{{ _reach_home }}/.reach/venv/bin/python"

- name: Install reach package
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.pip:
    name: "reach{% if reach_version != 'latest' %}=={{ reach_version }}{% endif %}"
    virtualenv: "{{ _reach_home }}/.reach/venv"
    state: "{{ 'latest' if reach_version == 'latest' else 'present' }}"
  when: reach_install_method == "pip"

- name: Check if SSH key exists
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.stat:
    path: "{{ _reach_home }}/.reach/id_ed25519"
  register: ssh_key

- name: Generate SSH key
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.command:
    cmd: "{{ _reach_home }}/.reach/venv/bin/reach --generate-key"
  when: not ssh_key.stat.exists
  register: keygen_result

- name: Read public key
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.slurp:
    src: "{{ _reach_home }}/.reach/id_ed25519.pub"
  register: public_key
  when: ssh_key.stat.exists or keygen_result is changed

- name: Display public key
  ansible.builtin.debug:
    msg: "Public key for {{ inventory_hostname }}: {{ public_key.content | b64decode }}"
  when: public_key is defined

- name: Create client configuration
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.template:
    src: config.yaml.j2
    dest: "{{ _reach_home }}/.reach/config.yaml"
    mode: "0600"
  notify: Restart reach-client

- name: Create systemd user service directory
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.file:
    path: "{{ _reach_home }}/.config/systemd/user"
    state: directory
    mode: "0755"

- name: Create systemd user service
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.template:
    src: reach-client.service.j2
    dest: "{{ _reach_home }}/.config/systemd/user/reach-client.service"
    mode: "0644"
  notify:
    - Reload user systemd
    - Restart reach-client

- name: Enable lingering for user
  become: true
  ansible.builtin.command:
    cmd: "loginctl enable-linger {{ _reach_user }}"
  changed_when: false

- name: Enable and start client service
  become: true
  become_user: "{{ _reach_user }}"
  ansible.builtin.systemd:
    name: reach-client
    enabled: "{{ reach_enable_service }}"
    state: "{{ 'started' if reach_start_service else 'stopped' }}"
    scope: user
    daemon_reload: true
