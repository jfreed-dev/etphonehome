name: Deploy Reach Server

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - 'shared/**'
      - 'web/**'
      - 'pyproject.toml'
      - '.github/workflows/deploy-server.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - 'production'
          - 'staging'
          - 'development'

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Build Svelte UI
        run: |
          cd web
          npm install
          npm run build
          cd ..

      - name: Copy Svelte build to server static
        run: |
          rm -rf server/static/*
          cp -r web/build/* server/static/

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[server]"

      - name: Run tests
        run: |
          pip install pytest pytest-asyncio
          pytest tests/ -v || echo "No tests found"

      - name: Verify required secrets
        run: |
          python3 -c "
          import os
          required = [
              'REACH_R2_ACCOUNT_ID', 'REACH_R2_ACCESS_KEY',
              'REACH_R2_SECRET_KEY', 'REACH_R2_BUCKET',
              'REACH_API_KEY', 'CF_DNS_API_TOKEN'
          ]
          missing = [v for v in required if not os.getenv(v)]
          if missing:
              print(f'âŒ Missing secrets: {missing}')
              exit(1)
          print('âœ… All required secrets configured')
          "
        env:
          REACH_R2_ACCOUNT_ID: ${{ secrets.REACH_R2_ACCOUNT_ID }}
          REACH_R2_ACCESS_KEY: ${{ secrets.REACH_R2_ACCESS_KEY }}
          REACH_R2_SECRET_KEY: ${{ secrets.REACH_R2_SECRET_KEY }}
          REACH_R2_BUCKET: ${{ secrets.REACH_R2_BUCKET }}
          REACH_API_KEY: ${{ secrets.REACH_API_KEY }}
          CF_DNS_API_TOKEN: ${{ secrets.CF_DNS_API_TOKEN }}

      - name: Test R2 connectivity
        run: |
          python3 -c "
          from shared.r2_client import create_r2_client
          r2 = create_r2_client()
          if r2 is None:
              print('âŒ Failed to create R2 client')
              exit(1)
          print('âœ… R2 client initialized successfully')
          "
        env:
          REACH_R2_ACCOUNT_ID: ${{ secrets.REACH_R2_ACCOUNT_ID }}
          REACH_R2_ACCESS_KEY: ${{ secrets.REACH_R2_ACCESS_KEY }}
          REACH_R2_SECRET_KEY: ${{ secrets.REACH_R2_SECRET_KEY }}
          REACH_R2_BUCKET: ${{ secrets.REACH_R2_BUCKET }}

      - name: Build deployment package
        run: |
          # Create deployment directory
          mkdir -p deploy_package

          # Copy necessary files
          cp -r server deploy_package/
          cp -r shared deploy_package/
          cp -r client deploy_package/
          cp pyproject.toml deploy_package/
          cp README.md deploy_package/

          # Create environment template without secrets
          cat > deploy_package/.env.example << EOF
          # Reach Server Configuration
          # Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          # Environment: ${{ github.event.inputs.environment || 'production' }}

          # API Authentication
          REACH_API_KEY=

          # R2 Storage
          REACH_R2_ACCOUNT_ID=
          REACH_R2_ACCESS_KEY=
          REACH_R2_SECRET_KEY=
          REACH_R2_BUCKET=
          REACH_R2_REGION=auto
          REACH_R2_API_TOKEN=

          # Cloudflare DNS
          CF_DNS_API_TOKEN=

          # Traefik Dashboard
          TRAEFIK_DASHBOARD_AUTH=

          # GitHub Configuration
          REACH_GITHUB_REPO=${{ github.repository }}
          REACH_GH_TOKEN=

          # Server Configuration
          REACH_HOST=0.0.0.0
          REACH_PORT=8765
          REACH_LOG_LEVEL=INFO
          EOF

          # Create deployment archive
          tar -czf reach-server.tar.gz -C deploy_package .

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: reach-server-${{ github.sha }}
          path: reach-server.tar.gz
          retention-days: 30

      - name: Deployment summary
        run: |
          echo "## Deployment Package Created ðŸ“¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Included Secrets" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API Key" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… R2 Storage (5 values)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cloudflare DNS Token" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Traefik Dashboard Auth" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Token" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifact from Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract: \`tar -xzf reach-server.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Source environment: \`source .env\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Start server: \`python -m server.mcp_server --transport http\`" >> $GITHUB_STEP_SUMMARY
